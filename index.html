<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Konseling BK (Tema Sekolah)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Mengatur font default Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f7ff; /* Latar belakang lembut seperti kertas */
        }
        
        /* Styling untuk scrollbar yang lebih halus */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #93c5fd; /* Sky-300 */ border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #e0f2fe; /* Sky-100 */ }
        
        /* Efek klik pada tombol */
        .btn-primary:active, .btn-secondary:active { transform: scale(0.98); }
        
        /* Warna status janji temu */
        .status-Pending { @apply bg-yellow-100 text-yellow-800 font-bold; }
        .status-Confirmed { @apply bg-green-100 text-green-800 font-bold; }
        .status-Rejected { @apply bg-red-100 text-red-800 font-bold; }
        .status-Completed { @apply bg-sky-100 text-sky-800 font-bold; }

        /* Styling spesifik untuk chat */
        .chat-message-user { @apply bg-sky-500 text-white self-end rounded-bl-2xl rounded-t-2xl shadow-md; }
        .chat-message-bk { @apply bg-amber-100 text-gray-800 self-start rounded-br-2xl rounded-t-2xl shadow-md border border-amber-200; }
        
        /* Style untuk Role Selector: Gradien papan tulis/mading */
        #role-selector { background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Screen 1: Role Selector -->
    <div id="role-selector" class="absolute inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border-t-8 border-amber-400 transform hover:scale-[1.01] transition duration-300">
            <i data-lucide="compass" class="w-14 h-14 text-sky-600 mx-auto mb-4 animate-bounce"></i>
            <h2 class="text-4xl font-extrabold text-gray-800 mb-2">Pusat BK Digital</h2>
            <p class="text-gray-600 mb-8 font-medium">Bimbingan & Konseling Sekolah</p>
            
            <button onclick="setRoleAndLogin('student')" class="btn-primary w-full bg-sky-600 text-white font-extrabold py-4 rounded-xl shadow-lg hover:bg-sky-700 transition duration-150 mb-4 flex items-center justify-center space-x-2 text-lg">
                <i data-lucide="user-plus" class="w-6 h-6"></i>
                <span>Login Siswa (Pencari Bimbingan)</span>
            </button>
            
            <button onclick="setRoleAndLogin('gurubk')" class="btn-secondary w-full bg-amber-500 text-gray-900 font-extrabold py-4 rounded-xl shadow-lg hover:bg-amber-600 transition duration-150 mb-4 flex items-center justify-center space-x-2 text-lg">
                <i data-lucide="graduation-cap" class="w-6 h-6"></i>
                <span>Login Guru BK (Mentor)</span>
            </button>

            <button onclick="setRoleAndLogin('admin')" class="btn-secondary w-full bg-gray-800 text-white font-extrabold py-4 rounded-xl shadow-lg hover:bg-gray-900 transition duration-150 mt-4 flex items-center justify-center space-x-2 text-lg">
                <i data-lucide="shield" class="w-6 h-6"></i>
                <span>Login Admin (Pengelola Sistem)</span>
            </button>
            <p id="role-auth-status" class="text-xs text-gray-500 mt-6">Mode Lokal: Data disimpan di browser.</p>
        </div>
    </div>
    
    <!-- Data Forms for First Time Users -->
    <div id="student-data-form" class="absolute inset-0 z-40 flex items-center justify-center p-4 bg-sky-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border-t-8 border-sky-500">
             <i data-lucide="notebook-pen" class="w-12 h-12 text-sky-600 mx-auto mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Data Siswa</h2>
            <p class="text-gray-600 mb-8 text-center">Siapkan buku catatan Anda!</p>
            <form id="student-info-form">
                <div class="mb-4">
                    <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="student-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: Budi Sanjaya">
                </div>
                <div class="mb-4">
                    <label for="student-school" class="block text-sm font-medium text-gray-700 mb-1">Asal Sekolah</label>
                    <input type="text" id="student-school" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: SMAN 1 Dramaga">
                </div>
                <div class="mb-6">
                    <label for="student-major" class="block text-sm font-medium text-gray-700 mb-1">Jurusan / Kelas</label>
                    <input type="text" id="student-major" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: IPA 12 / RPL">
                </div>
                <button type="submit" class="btn-primary w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-sky-700 transition duration-150 flex items-center justify-center space-x-2 shadow-lg">
                    <i data-lucide="arrow-right-circle" class="w-5 h-5"></i><span>Mulai Belajar</span>
                </button>
            </form>
        </div>
    </div>

    <div id="gurubk-data-form" class="absolute inset-0 z-40 flex items-center justify-center p-4 bg-amber-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border-t-8 border-amber-500">
            <i data-lucide="user-cog" class="w-12 h-12 text-amber-600 mx-auto mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Data Guru BK</h2>
            <p class="text-gray-600 mb-8 text-center">Siap membimbing siswa.</p>
            <form id="gurubk-info-form">
                <div class="mb-4">
                    <label for="gurubk-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="gurubk-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 bg-amber-50" placeholder="Contoh: Ibu S.Pd">
                </div>
                <div class="mb-6">
                    <label for="gurubk-phone" class="block text-sm font-medium text-gray-700 mb-1">Nomor Telepon</label>
                    <input type="tel" id="gurubk-phone" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 bg-amber-50" placeholder="Contoh: 081234567890">
                </div>
                <button type="submit" class="btn-primary w-full bg-amber-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-amber-700 transition duration-150 flex items-center justify-center space-x-2 shadow-lg">
                    <i data-lucide="arrow-right-circle" class="w-5 h-5"></i><span>Masuk ke Panel Guru BK</span>
                </button>
            </form>
        </div>
    </div>
    
    <div id="admin-data-form" class="absolute inset-0 z-40 flex items-center justify-center p-4 bg-gray-100 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border-t-8 border-gray-800">
            <i data-lucide="server-cog" class="w-12 h-12 text-gray-800 mx-auto mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Data Admin</h2>
            <p class="text-gray-600 mb-8 text-center">Pengelola seluruh sistem.</p>
            <form id="admin-info-form">
                <div class="mb-6">
                    <label for="admin-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap Admin</label>
                    <input type="text" id="admin-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-gray-800 focus:border-gray-800 bg-gray-50" placeholder="Contoh: Pengelola Sistem">
                </div>
                <button type="submit" class="btn-primary w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-900 transition duration-150 flex items-center justify-center space-x-2 shadow-lg">
                    <i data-lucide="arrow-right-circle" class="w-5 h-5"></i><span>Masuk ke Panel Admin</span>
                </button>
            </form>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="main-app-container" class="flex flex-1 hidden">
        <nav id="mobile-nav" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-2xl z-20 md:hidden"></nav>
        <aside id="desktop-nav" class="hidden md:flex flex-col w-72 bg-white border-r border-gray-200 p-6 shadow-xl"></aside>

        <!-- Content Area -->
        <main class="flex-1 p-4 md:p-8 pb-20 md:pb-8 overflow-y-auto">
            
            <!-- Student View -->
            <div id="student-view" class="h-full w-full hidden">
                <!-- Tab: Materi Motivasi -->
                <div id="tab-materi" class="tab-content hidden">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-sky-400 pb-2">Materi Inspirasi</h2>
                    <p class="text-gray-600 mb-8 font-medium">Temukan semangat baru dan tips yang relevan untuk perkembangan akademik dan pribadi Anda.</p>
                    <div id="motivational-posts-list" class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3"></div>
                </div>

                <!-- Tab: Janji Temu BK -->
                <div id="tab-appointment" class="tab-content hidden">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-sky-400 pb-2">Jadwal Konseling</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-8 border-t-8 border-amber-400">
                        <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center text-amber-600"><i data-lucide="calendar-plus" class="w-6 h-6 mr-2"></i>Buat Janji Baru</h3>
                        <form id="appointment-form">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="mb-4">
                                    <label for="appointment-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                    <input type="date" id="appointment-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50">
                                </div>
                                <div class="mb-4">
                                    <label for="appointment-time" class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
                                    <input type="time" id="appointment-time" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="appointment-reason" class="block text-sm font-medium text-gray-700 mb-1">Alasan Singkat Konseling</label>
                                <textarea id="appointment-reason" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: Kesulitan mengatur waktu belajar..."></textarea>
                            </div>
                            <button type="submit" class="btn-primary w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-sky-700 transition shadow-md">Kirim Permintaan</button>
                        </form>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-4 mt-8">Riwayat Janji Temu Saya</h3>
                    <div id="appointments-list" class="space-y-4">
                        <p id="no-appointments" class="text-gray-500 italic hidden">Belum ada janji temu.</p>
                    </div>
                </div>

                <!-- Tab: Chat Privasi -->
                <div id="tab-chat" class="tab-content hidden h-full flex flex-col">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-4 border-b-4 border-sky-400 pb-2">Ruang Chat Privasi</h2>
                    <p class="text-gray-600 mb-6 font-medium">Saluran rahasia Anda untuk berkomunikasi langsung dengan Guru BK.</p>
                    <div class="bg-amber-50 p-4 rounded-2xl shadow-md mb-6 border border-amber-200">
                         <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                            <div class="flex items-center">
                                <i data-lucide="phone-call" class="w-6 h-6 text-amber-600 mr-3"></i>
                                <div>
                                    <p class="text-sm font-semibold text-amber-700">Hubungi Cepat Guru BK (Nomor Contoh):</p>
                                    <a href="tel:+6285694009155" class="text-lg font-bold text-amber-800 hover:underline">085694009155</a>
                                </div>
                            </div>
                            <a href="https://wa.me/6285694009155" target="_blank" class="w-full sm:w-auto bg-amber-600 text-white font-bold py-2 px-4 rounded-xl hover:bg-amber-700 transition duration-150 flex items-center justify-center space-x-2 shadow-md">
                                <i data-lucide="message-square" class="w-4 h-4"></i><span>Chat di WhatsApp</span>
                            </a>
                        </div>
                    </div>
                    <div class="flex-1 bg-white p-4 rounded-2xl shadow-xl flex flex-col overflow-hidden h-[60vh] md:h-[70vh] border-2 border-sky-100">
                        <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 custom-scrollbar p-2"></div>
                        <form id="chat-form" class="mt-4 flex space-x-3">
                            <input type="text" id="chat-input" required placeholder="Tulis masukan, pertanyaan, atau keluhan Anda..." class="flex-1 p-3 border-2 border-sky-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50">
                            <button type="submit" class="btn-primary bg-sky-600 text-white p-3 rounded-xl hover:bg-sky-700 transition flex items-center justify-center shadow-md">
                                <i data-lucide="send" class="w-5 h-5"></i><span class="hidden sm:inline ml-2">Kirim</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Guru BK View -->
            <div id="gurubk-view" class="h-full w-full hidden">
                <h2 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-amber-400 pb-2">Panel Guru BK</h2>
                <div id="gurubk-content" class="h-full">
                    <!-- Tab: Antrean Janji Temu -->
                    <div id="tab-gurubk-appointments" class="gurubk-tab-content h-full hidden">
                         <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-amber-500">
                            <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center text-amber-700">
                                <i data-lucide="inbox" class="w-6 h-6 mr-2"></i>Antrean Janji Temu Masuk
                            </h3>
                            <div id="gurubk-appointments-list" class="space-y-4">
                                <p id="no-gurubk-appointments" class="text-gray-500 italic">Tidak ada janji temu baru.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Chat Siswa -->
                    <div id="tab-gurubk-chat" class="gurubk-tab-content hidden h-full flex flex-col">
                        <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-amber-500 flex-1">
                            <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center text-amber-700">
                                <i data-lucide="message-circle-more" class="w-6 h-6 mr-2"></i>Kotak Masuk Chat Siswa
                            </h3>
                            <div id="gurubk-chat-threads" class="space-y-3 max-h-[80vh] overflow-y-auto custom-scrollbar">
                                <p id="no-chat-threads" class="text-gray-500 italic">Belum ada pesan dari Siswa.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Kelola Materi -->
                    <div id="tab-gurubk-materi" class="gurubk-tab-content hidden">
                        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 border-t-8 border-sky-500">
                            <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center text-sky-700"><i data-lucide="book-open-text" class="w-6 h-6 mr-2"></i>Kelola Materi Motivasi</h3>
                            <form id="materi-form">
                                <input type="hidden" id="materi-id">
                                <div class="mb-4">
                                    <label for="materi-title" class="block text-sm font-medium text-gray-700 mb-1">Judul Materi</label>
                                    <input type="text" id="materi-title" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: 3 Kunci Fokus Belajar">
                                </div>
                                <div class="mb-6">
                                    <label for="materi-content" class="block text-sm font-medium text-gray-700 mb-1">Isi Materi</label>
                                    <textarea id="materi-content" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Tuliskan konten motivasi di sini..."></textarea>
                                </div>
                                <button type="submit" id="materi-submit-btn" class="btn-primary w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-sky-700 transition shadow-md">Tambah Materi</button>
                            </form>
                        </div>

                        <h3 class="text-3xl font-bold text-gray-800 mb-4 mt-8">Daftar Materi Aktif</h3>
                        <div id="gurubk-materi-list" class="space-y-4">
                            <p id="no-gurubk-materi" class="text-gray-500 italic">Belum ada materi yang dibuat.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="h-full w-full hidden">
                 <h2 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-gray-700 pb-2">Dashboard Admin Pengelola</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Kolom Pengguna Terdaftar -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-gray-700">
                        <h3 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"><i data-lucide="users" class="w-6 h-6 mr-2 text-gray-700"></i>Pengguna Terdaftar</h3>
                        <div id="admin-users-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar"></div>
                    </div>
                    <!-- Kolom Semua Janji Temu -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-gray-700">
                         <h3 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"><i data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-gray-700"></i>Seluruh Janji Temu</h3>
                         <div id="admin-all-appointments-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar"></div>
                    </div>
                 </div>
                 
                 <!-- Laporan Siswa / Sistem -->
                 <div class="mt-8 bg-white p-6 rounded-2xl shadow-2xl border-t-8 border-gray-800">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><i data-lucide="book-text" class="w-6 h-6 mr-2 text-gray-800"></i>Laporan & Statistik Sistem</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-sky-50 rounded-xl text-center shadow-inner"><p class="text-3xl font-extrabold text-sky-800" id="stat-students">0</p><p class="text-sm text-sky-600 font-semibold">Total Siswa</p></div>
                        <div class="p-4 bg-amber-50 rounded-xl text-center shadow-inner"><p class="text-3xl font-extrabold text-amber-800" id="stat-appointments">0</p><p class="text-sm text-amber-600 font-semibold">Total Janji</p></div>
                        <div class="p-4 bg-yellow-50 rounded-xl text-center shadow-inner"><p class="text-3xl font-extrabold text-yellow-800" id="stat-pending">0</p><p class="text-sm text-yellow-600 font-semibold">Janji Tertunda</p></div>
                    </div>
                    <button onclick="viewSystemReport()" class="btn-primary w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-800 transition flex items-center justify-center space-x-2 shadow-md">
                        <i data-lucide="download" class="w-5 h-5"></i><span>Lihat Laporan Detail Siswa</span>
                    </button>
                 </div>
            </div>

            <!-- Custom Modal -->
            <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full border-t-8 border-sky-500">
                    <h3 id="modal-title" class="text-2xl font-bold mb-3 text-sky-700 flex items-center"><i data-lucide="bell" class="w-6 h-6 mr-2"></i>Notifikasi</h3>
                    <div id="modal-message" class="text-gray-600 mb-5 overflow-y-auto max-h-64 whitespace-pre-wrap text-sm border-b pb-3"></div>
                    <button id="modal-close-btn" class="w-full bg-sky-600 text-white font-bold py-3 rounded-xl hover:bg-sky-700 shadow-md">Tutup</button>
                </div>
            </div>

             <!-- Chat View/Reply Modal for Guru BK -->
            <div id="chat-reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full h-[90vh] flex flex-col border-t-8 border-amber-500">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-2xl font-bold text-amber-700">Chat dengan <span id="chat-reply-student-name"></span></h3>
                        <button onclick="closeChatReplyModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div id="gurubk-specific-chat-messages" class="flex-1 overflow-y-auto space-y-4 custom-scrollbar p-2 mb-4 bg-sky-50 rounded-xl border border-sky-200">
                        <!-- Messages render here -->
                    </div>
                    
                    <form id="gurubk-chat-reply-form" class="flex space-x-3">
                        <input type="text" id="gurubk-chat-reply-input" required placeholder="Balas pesan siswa (seperti menggunakan pena)..." class="flex-1 p-3 border-2 border-amber-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 bg-amber-50">
                        <button type="submit" class="btn-primary bg-amber-600 text-white p-3 rounded-xl hover:bg-amber-700 transition flex items-center justify-center shadow-md">
                            <i data-lucide="send" class="w-5 h-5"></i><span class="hidden sm:inline ml-2">Balas</span>
                        </button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <!-- Local App Logic -->
    <script>
        // --- Global State & Mock Data ---
        let userRole = null; 
        let studentProfile = null; 
        let guruBkProfile = null;
        let adminProfile = null;
        // In a real app, this would be dynamic from Firebase Auth
        let userId = 'local_student_01'; // Static ID for local simulation
        
        // Use a standard mock post structure.
        let localMotivationalPosts = [
            { id: 'post1', title: 'Kunci Sukses: Konsistensi Kecil', content: 'Kesuksesan bukanlah hasil dari tindakan besar yang jarang dilakukan, melainkan serangkaian kebiasaan kecil yang diulang setiap hari. Mulailah dari langkah termudah.', author: 'BK Sekolah' },
            { id: 'post2', title: 'Mengatasi Prokrastinasi', content: 'Teknik "5 Menit": Mulai tugas yang Anda tunda hanya selama 5 menit. Seringkali, begitu Anda memulai, inersia akan membawa Anda untuk menyelesaikannya lebih lama. Jangan takut memulai.', author: 'BK Sekolah' },
        ];
        
        let localAppointments = [];
        let localChatMessages = [];
        
        // Variable to track the student currently being replied to by Guru BK
        let currentChatStudentId = null; 
        
        // --- LocalStorage Persistence ---
        function saveDataToLocalStorage() {
            localStorage.setItem('bkApp_studentProfile', JSON.stringify(studentProfile));
            localStorage.setItem('bkApp_guruBkProfile', JSON.stringify(guruBkProfile));
            localStorage.setItem('bkApp_adminProfile', JSON.stringify(adminProfile));
            localStorage.setItem('bkApp_appointments', JSON.stringify(localAppointments));
            localStorage.setItem('bkApp_chatMessages', JSON.stringify(localChatMessages));
            localStorage.setItem('bkApp_motivationalPosts', JSON.stringify(localMotivationalPosts));
        }

        function loadDataFromLocalStorage() {
            studentProfile = JSON.parse(localStorage.getItem('bkApp_studentProfile'));
            guruBkProfile = JSON.parse(localStorage.getItem('bkApp_guruBkProfile'));
            adminProfile = JSON.parse(localStorage.getItem('bkApp_adminProfile'));
            
            const appointmentsData = JSON.parse(localStorage.getItem('bkApp_appointments')) || [];
            localAppointments = appointmentsData.map(app => ({...app, createdAt: new Date(app.createdAt) }));

            const chatData = JSON.parse(localStorage.getItem('bkApp_chatMessages')) || [];
            localChatMessages = chatData.map(msg => ({...msg, timestamp: new Date(msg.timestamp) }));
            
            const postsData = JSON.parse(localStorage.getItem('bkApp_motivationalPosts')) || localMotivationalPosts;
            localMotivationalPosts = postsData;

            // Ensure static studentId is used if studentProfile exists (for chat/app consistency)
            if (studentProfile) {
                userId = studentProfile.id || 'local_student_01';
            }
        }
        
        // --- Utility Functions ---
        function showCustomModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('custom-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        document.getElementById('modal-close-btn').onclick = () => document.getElementById('custom-modal').classList.add('hidden');
        function closeChatReplyModal() { document.getElementById('chat-reply-modal').classList.add('hidden'); currentChatStudentId = null; }
        window.closeChatReplyModal = closeChatReplyModal;
        
        function returnToRoleSelector() { 
            // Save state before reloading
            saveDataToLocalStorage();
            window.location.reload(); 
        }
        window.returnToRoleSelector = returnToRoleSelector;

        // --- Display Info Updaters ---
        const updateDisplayInfo = () => {
            if (userRole === 'student' && studentProfile) document.getElementById('user-name-display').textContent = studentProfile.fullName;
            if (userRole === 'gurubk' && guruBkProfile) document.getElementById('gurubk-name-display').textContent = guruBkProfile.fullName;
            if (userRole === 'admin' && adminProfile) document.getElementById('admin-name-display').textContent = adminProfile.fullName;
        };

        // --- Role & View Management ---
        function proceedToApp() {
            ['role-selector', 'student-data-form', 'gurubk-data-form', 'admin-data-form'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('main-app-container').classList.remove('hidden');
            
            ['student-view', 'gurubk-view', 'admin-view'].forEach(id => document.getElementById(id).classList.add('hidden'));

            if (userRole === 'student') {
                document.getElementById('student-view').classList.remove('hidden');
                loadStudentLayout();
                loadInitialStudentData();
            } else if (userRole === 'gurubk') {
                document.getElementById('gurubk-view').classList.remove('hidden');
                loadGuruBkLayout();
                loadInitialGuruBkData(); // New function for BK data
            } else if (userRole === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                loadAdminLayout();
                renderAdminDashboard();
            }
            
            updateDisplayInfo();
            document.getElementById('auth-status').textContent = `Status: Terhubung (${userRole.toUpperCase()})`;
            lucide.createIcons();
        }

        function setRoleAndLogin(role) {
            userRole = role;
            
            // Re-assign userId for student based on local data if exists
            if (role === 'student' && studentProfile && studentProfile.id) {
                userId = studentProfile.id;
            } else if (role === 'student') {
                userId = `local_student_${Date.now()}`; // New student gets a fresh ID
            }

            let profileExists = (role === 'student' && studentProfile) || (role === 'gurubk' && guruBkProfile) || (role === 'admin' && adminProfile);
            
            if (profileExists) {
                proceedToApp();
            } else {
                document.getElementById('role-selector').classList.add('hidden');
                document.getElementById(`${role}-data-form`).classList.remove('hidden');
                lucide.createIcons();
            }
        }
        window.setRoleAndLogin = setRoleAndLogin;

        // --- Navigation Logic ---
        // Student Navigation
        const studentTabs = ['materi', 'appointment', 'chat'];
        function setActiveTab(tabName) {
            studentTabs.forEach(tab => {
                document.getElementById(`tab-${tab}`).classList.add('hidden');
                document.querySelector(`#desktop-nav .tab-${tab}`)?.classList.remove('bg-sky-100', 'text-sky-700', 'font-bold', 'border-r-4');
                document.querySelector(`#mobile-nav .tab-${tab}`)?.classList.remove('text-sky-600');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelector(`#desktop-nav .tab-${tabName}`)?.classList.add('bg-sky-100', 'text-sky-700', 'font-bold', 'border-r-4', 'border-sky-500');
            document.querySelector(`#mobile-nav .tab-${tabName}`)?.classList.add('text-sky-600');
            if (tabName === 'chat') setTimeout(() => document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight, 50);
            lucide.createIcons();
        }
        window.setActiveTab = setActiveTab;
        
        // Guru BK Navigation
        const gurubkTabs = ['appointments', 'chat', 'materi'];
        function setActiveGuruBkTab(tabName) {
            gurubkTabs.forEach(tab => {
                document.getElementById(`tab-gurubk-${tab}`).classList.add('hidden');
                document.querySelector(`#desktop-nav .tab-gurubk-${tab}`)?.classList.remove('bg-amber-100', 'text-amber-700', 'font-bold', 'border-r-4');
            });
            document.getElementById(`tab-gurubk-${tabName}`).classList.remove('hidden');
            document.querySelector(`#desktop-nav .tab-gurubk-${tabName}`)?.classList.add('bg-amber-100', 'text-amber-700', 'font-bold', 'border-r-4', 'border-amber-500');
            if (tabName === 'chat') renderGurubkChatThreads();
            if (tabName === 'materi') renderMateriManagementList();
            lucide.createIcons();
        }
        window.setActiveGuruBkTab = setActiveGuruBkTab;


        // --- Layout Loaders ---
        function loadStudentLayout() {
            // Mobile Nav
            const mobileNavHtml = `<div class="flex justify-around items-center h-16"><button onclick="setActiveTab('materi')" class="nav-btn text-gray-600 hover:text-sky-600 flex flex-col items-center p-2 tab-materi"><i data-lucide="book-open" class="w-5 h-5"></i><span class="text-xs mt-1 font-medium">Motivasi</span></button><button onclick="setActiveTab('appointment')" class="nav-btn text-gray-600 hover:text-sky-600 flex flex-col items-center p-2 tab-appointment"><i data-lucide="calendar-check" class="w-5 h-5"></i><span class="text-xs mt-1 font-medium">Janji Temu</span></button><button onclick="setActiveTab('chat')" class="nav-btn text-gray-600 hover:text-sky-600 flex flex-col items-center p-2 tab-chat"><i data-lucide="message-circle" class="w-5 h-5"></i><span class="text-xs mt-1 font-medium">Chat</span></button></div><button onclick="returnToRoleSelector()" class="w-full bg-red-600 text-white text-xs font-medium py-2 flex items-center justify-center space-x-1 hover:bg-red-700"><i data-lucide="log-out" class="w-4 h-4"></i><span>Keluar</span></button>`;
            document.getElementById('mobile-nav').innerHTML = mobileNavHtml;
            // Desktop Nav
            const sidebarHtml = `<h1 class="text-3xl font-extrabold text-sky-700 mb-8 flex items-center"><i data-lucide="school" class="w-8 h-8 mr-2"></i>BK Hub</h1><div class="flex flex-col space-y-2"><button onclick="setActiveTab('materi')" class="nav-btn w-full text-left p-4 rounded-xl text-gray-700 hover:bg-sky-50 flex items-center space-x-3 tab-materi"><i data-lucide="book-open" class="w-5 h-5"></i><span>Materi Inspirasi</span></button><button onclick="setActiveTab('appointment')" class="nav-btn w-full text-left p-4 rounded-xl text-gray-700 hover:bg-sky-50 flex items-center space-x-3 tab-appointment"><i data-lucide="calendar-check" class="w-5 h-5"></i><span>Jadwal Konseling</span></button><button onclick="setActiveTab('chat')" class="nav-btn w-full text-left p-4 rounded-xl text-gray-700 hover:bg-sky-50 flex items-center space-x-3 tab-chat"><i data-lucide="message-circle" class="w-5 h-5"></i><span>Chat Privasi</span></button></div><div class="mt-auto pt-6 border-t border-gray-100"><p class="text-xs text-gray-500">Profil Siswa:</p><p id="user-name-display" class="text-lg font-bold text-gray-800 break-words mb-2"></p><div id="auth-status" class="mt-2 text-xs font-medium text-sky-600"></div><button onclick="returnToRoleSelector()" class="w-full mt-4 text-sm text-red-600 hover:text-red-800 flex items-center justify-center font-semibold"><i data-lucide="log-out" class="w-4 h-4 mr-1"></i>Keluar Akun</button></div>`;
            document.getElementById('desktop-nav').innerHTML = sidebarHtml;
            setActiveTab('materi');
            document.getElementById('mobile-nav').classList.remove('hidden');
        }

        function loadGuruBkLayout() {
            // Mobile navigation is hidden for Guru BK/Admin to force desktop-like interface on mobile
            document.getElementById('mobile-nav').classList.add('hidden');
            // Desktop Nav (Sidebar)
            const sidebarHtml = `<h1 class="text-3xl font-extrabold text-amber-700 mb-8 flex items-center"><i data-lucide="pencil-ruler" class="w-8 h-8 mr-2"></i>BK Mentor</h1><div class="flex flex-col space-y-2"><button onclick="setActiveGuruBkTab('appointments')" class="nav-btn w-full text-left p-4 rounded-xl text-gray-700 hover:bg-amber-50 flex items-center space-x-3 tab-gurubk-appointments"><i data-lucide="clipboard-list" class="w-5 h-5"></i><span>Antrean Konseling</span></button><button onclick="setActiveGuruBkTab('chat')" class="nav-btn w-full text-left p-4 rounded-xl text-gray-700 hover:bg-amber-50 flex items-center space-x-3 tab-gurubk-chat"><i data-lucide="message-circle-more" class="w-5 h-5"></i><span>Kotak Masuk Chat</span></button><button onclick="setActiveGuruBkTab('materi')" class="nav-btn w-full text-left p-4 rounded-xl text-gray-700 hover:bg-amber-50 flex items-center space-x-3 tab-gurubk-materi"><i data-lucide="book-open-text" class="w-5 h-5"></i><span>Kelola Materi</span></button></div><div class="mt-auto pt-6 border-t border-gray-100"><p class="text-xs text-gray-500">Profil Guru BK:</p><p id="gurubk-name-display" class="text-lg font-bold text-gray-800 break-words mb-2"></p><div id="auth-status" class="mt-2 text-xs font-medium text-amber-600"></div><button onclick="returnToRoleSelector()" class="w-full mt-4 text-sm text-red-600 hover:text-red-800 flex items-center justify-center font-semibold"><i data-lucide="log-out" class="w-4 h-4 mr-1"></i>Keluar Akun</button></div>`;
            document.getElementById('desktop-nav').innerHTML = sidebarHtml;
            setActiveGuruBkTab('appointments');
        }

        function loadAdminLayout() {
            document.getElementById('mobile-nav').classList.add('hidden');
            const sidebarHtml = `<h1 class="text-3xl font-extrabold text-gray-800 mb-8 flex items-center"><i data-lucide="hard-hat" class="w-8 h-8 mr-2"></i>BK Admin</h1><div class="flex flex-col space-y-2"><div class="w-full text-left p-4 rounded-xl bg-gray-100 text-gray-800 font-bold flex items-center space-x-3 border-r-4 border-gray-700"><i data-lucide="database" class="w-5 h-5"></i><span>Dashboard Utama</span></div></div><div class="mt-auto pt-6 border-t border-gray-100"><p class="text-xs text-gray-500">Profil Admin:</p><p id="admin-name-display" class="text-lg font-bold text-gray-800 break-words mb-2"></p><div id="auth-status" class="mt-2 text-xs font-medium text-gray-600"></div><button onclick="returnToRoleSelector()" class="w-full mt-4 text-sm text-red-600 hover:text-red-800 flex items-center justify-center font-semibold"><i data-lucide="log-out" class="w-4 h-4 mr-1"></i>Keluar Akun</button></div>`;
            document.getElementById('desktop-nav').innerHTML = sidebarHtml;
        }

        // --- Data Form Handling ---
        document.getElementById('student-info-form').addEventListener('submit', (e) => {
            e.preventDefault();
            studentProfile = { id: userId, fullName: document.getElementById('student-name').value.trim(), school: document.getElementById('student-school').value.trim(), major: document.getElementById('student-major').value.trim(), role: 'Siswa' };
            saveDataToLocalStorage();
            proceedToApp();
        });

        document.getElementById('gurubk-info-form').addEventListener('submit', (e) => {
            e.preventDefault();
            guruBkProfile = { fullName: document.getElementById('gurubk-name').value.trim(), phoneNumber: document.getElementById('gurubk-phone').value.trim(), role: 'Guru BK' };
            saveDataToLocalStorage();
            proceedToApp();
        });
        
        document.getElementById('admin-info-form').addEventListener('submit', (e) => {
            e.preventDefault();
            adminProfile = { fullName: document.getElementById('admin-name').value.trim(), role: 'Admin' };
            saveDataToLocalStorage();
            proceedToApp();
        });
        
        // --- Student Features ---
        const renderMotivationalPosts = () => { document.getElementById('motivational-posts-list').innerHTML = localMotivationalPosts.map(post => `<div class="bg-white p-6 rounded-2xl shadow-xl border-l-8 border-sky-400 hover:shadow-2xl transition duration-200"><h4 class="text-xl font-bold text-gray-800 mb-2">${post.title}</h4><p class="text-gray-600 mb-4 line-clamp-3">${post.content}</p><p class="text-xs text-sky-500 font-medium flex items-center"><i data-lucide="user-check" class="w-4 h-4 mr-1"></i>Oleh: ${post.author}</p></div>`).join(''); lucide.createIcons(); };
        
        document.getElementById('appointment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            localAppointments.unshift({ id: `app_${Date.now()}`, date: document.getElementById('appointment-date').value, time: document.getElementById('appointment-time').value, reason: document.getElementById('appointment-reason').value.trim(), studentId: userId, studentName: studentProfile.fullName, status: 'Pending', createdAt: new Date() });
            renderAppointments();
            saveDataToLocalStorage();
            showCustomModal('Permintaan Terkirim!', 'Permintaan janji temu Anda berhasil dicatat. Guru BK akan segera mengonfirmasi jadwal Anda.');
            e.target.reset();
        });

        const renderAppointments = () => {
            const list = document.getElementById('appointments-list'), noApps = document.getElementById('no-appointments');
            const studentAppointments = localAppointments.filter(app => app.studentId === userId);
            noApps.classList.toggle('hidden', studentAppointments.length > 0);
            list.innerHTML = studentAppointments.map(app => `<div class="bg-white p-4 rounded-xl shadow-md border-l-8 ${app.status === 'Confirmed' ? 'border-green-500' : app.status === 'Rejected' ? 'border-red-500' : 'border-yellow-500'}"><div class="flex justify-between items-start"><p class="font-bold text-gray-800 text-lg">${app.date} Pukul ${app.time}</p><span class="status-${app.status} px-3 py-1 text-xs font-semibold rounded-full">${app.status}</span></div><p class="text-sm text-gray-600 mt-2">Alasan: ${app.reason}</p><p class="text-xs text-gray-400 mt-2">Diajukan: ${new Date(app.createdAt).toLocaleDateString('id-ID', { hour: '2-digit', minute: '2-digit' })}</p></div>`).join('');
        };
        
        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const chatInput = document.getElementById('chat-input');
            if (!chatInput.value.trim()) return;
            localChatMessages.push({ senderId: userId, senderName: studentProfile.fullName, message: chatInput.value.trim(), timestamp: new Date(), role: 'student' });
            renderChatMessages();
            chatInput.value = '';
            saveDataToLocalStorage();
        });

        const renderChatMessages = () => {
            const list = document.getElementById('chat-messages');
            // Filter messages for the current student
            const studentMessages = localChatMessages.filter(msg => msg.senderId === userId || msg.recipientId === userId);
            
            list.innerHTML = studentMessages.map(msg => {
                // True if message is from student
                const isUser = msg.role === 'student'; 
                
                return `<div class="max-w-[85%] ${isUser ? 'chat-message-user ml-auto' : 'chat-message-bk mr-auto'} p-3 text-sm"><p>${!isUser ? `<span class="font-bold">Guru BK</span>: ` : ''}${msg.message}</p><p class="text-xs ${isUser ? 'text-sky-100' : 'text-amber-500'} text-right mt-1">${msg.timestamp.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</p></div>`;
            }).join('');
            list.scrollTop = list.scrollHeight;
        };
        
        // --- Guru BK Features ---
        function loadInitialGuruBkData() {
            renderGuruBkAppointments();
            renderGurubkChatThreads();
            renderMateriManagementList();
        }

        window.updateAppointmentStatus = (docId, newStatus) => {
            const appointment = localAppointments.find(app => app.id === docId);
            if (appointment) {
                appointment.status = newStatus;
                renderGuruBkAppointments();
                renderAppointments(); // Update student view if needed
                saveDataToLocalStorage();
                showCustomModal('Aksi Berhasil', `Status Janji Temu diperbarui menjadi **${newStatus}**.`);
            }
        };

        const renderGuruBkAppointments = () => {
            const list = document.getElementById('gurubk-appointments-list'), noApps = document.getElementById('no-gurubk-appointments');
            const pending = localAppointments.filter(app => app.status !== 'Completed').sort((a,b) => b.createdAt - a.createdAt);
            noApps.classList.toggle('hidden', pending.length > 0);
            list.innerHTML = pending.map(app => `<div class="bg-amber-50 p-4 rounded-xl border border-amber-200 shadow-md"><div class="flex justify-between items-start mb-2"><p class="font-bold text-lg text-gray-800">${app.date} Pukul ${app.time}</p><span class="status-${app.status} px-3 py-1 text-xs font-semibold rounded-full">${app.status}</span></div><p class="text-sm text-gray-700">Oleh: <span class="font-semibold">${app.studentName}</span></p><p class="text-sm text-gray-600 mt-1">Alasan: ${app.reason}</p><div class="mt-4 pt-3 border-t border-gray-200 flex flex-wrap gap-2"><button onclick="updateAppointmentStatus('${app.id}', 'Confirmed')" class="btn-primary flex-1 bg-green-500 text-white text-xs py-2 px-3 rounded-lg hover:bg-green-600 shadow-sm">Konfirmasi</button><button onclick="updateAppointmentStatus('${app.id}', 'Rejected')" class="btn-primary flex-1 bg-red-500 text-white text-xs py-2 px-3 rounded-lg hover:bg-red-600 shadow-sm">Tolak</button><button onclick="updateAppointmentStatus('${app.id}', 'Completed')" class="btn-secondary flex-1 bg-sky-500 text-white text-xs py-2 px-3 rounded-lg hover:bg-sky-600 shadow-sm">Selesaikan</button></div></div>`).join('');
            lucide.createIcons();
        };
        
        // --- Guru BK Chat Management ---
        const getUniqueChatSenders = () => {
            // Find all unique student IDs who have sent messages
            const studentMessages = localChatMessages.filter(msg => msg.role === 'student');
            const uniqueIds = [...new Set(studentMessages.map(msg => msg.senderId))];
            
            // Map IDs to the latest message and student name
            return uniqueIds.map(id => {
                const threadMessages = localChatMessages.filter(msg => msg.senderId === id || msg.recipientId === id).sort((a, b) => b.timestamp - a.timestamp);
                const latestMessage = threadMessages[0];
                return {
                    studentId: id,
                    studentName: latestMessage.senderName || 'Siswa',
                    latestMessageText: latestMessage.message,
                    latestTimestamp: latestMessage.timestamp
                };
            }).sort((a,b) => b.latestTimestamp - a.latestTimestamp); // Sort by latest activity
        };

        const renderGurubkChatThreads = () => {
            const list = document.getElementById('gurubk-chat-threads'), noThreads = document.getElementById('no-chat-threads');
            const threads = getUniqueChatSenders();
            noThreads.classList.toggle('hidden', threads.length > 0);

            list.innerHTML = threads.map(thread => `
                <div onclick="openChatReplyModal('${thread.studentId}', '${thread.studentName}')" class="p-4 bg-sky-50 hover:bg-sky-100 rounded-xl border border-sky-200 cursor-pointer transition shadow-sm">
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-gray-800">${thread.studentName}</p>
                        <p class="text-xs text-gray-500">${thread.latestTimestamp.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                    <p class="text-sm text-gray-600 mt-1 line-clamp-1">${thread.latestMessageText}</p>
                </div>
            `).join('');
        };
        window.openChatReplyModal = (studentId, studentName) => {
            currentChatStudentId = studentId;
            document.getElementById('chat-reply-student-name').textContent = studentName;
            
            // Render specific chat messages
            const renderSpecificChat = () => {
                 const chatList = document.getElementById('gurubk-specific-chat-messages');
                 const threadMessages = localChatMessages.filter(msg => msg.senderId === studentId || msg.recipientId === studentId).sort((a, b) => a.timestamp - b.timestamp);
                 
                 chatList.innerHTML = threadMessages.map(msg => {
                    const isGuruBk = msg.role === 'gurubk';
                    return `<div class="max-w-[85%] ${isGuruBk ? 'chat-message-bk ml-auto' : 'chat-message-user mr-auto'} p-3 text-sm"><p class="font-semibold">${isGuruBk ? 'Anda (BK):' : msg.senderName}:</p><p>${msg.message}</p><p class="text-xs ${isGuruBk ? 'text-amber-500' : 'text-sky-100'} text-right mt-1">${msg.timestamp.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</p></div>`;
                }).join('');
                chatList.scrollTop = chatList.scrollHeight;
            };
            
            // Bind reply submission
            document.getElementById('gurubk-chat-reply-form').onsubmit = (e) => {
                e.preventDefault();
                const replyInput = document.getElementById('gurubk-chat-reply-input');
                if (!replyInput.value.trim()) return;

                localChatMessages.push({
                    senderId: 'BK_Teacher', 
                    recipientId: currentChatStudentId,
                    senderName: guruBkProfile.fullName,
                    message: replyInput.value.trim(), 
                    timestamp: new Date(), 
                    role: 'gurubk' 
                });

                renderSpecificChat();
                // If the student is currently logged in, update their chat view too
                if (userRole === 'student' && userId === currentChatStudentId) renderChatMessages();
                
                replyInput.value = '';
                saveDataToLocalStorage();
                renderGurubkChatThreads(); // Update thread list
            };
            
            renderSpecificChat();
            document.getElementById('chat-reply-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('gurubk-chat-reply-input').focus(), 100);
        };
        
        // --- Guru BK Materi Management (CRUD) ---
        const renderMateriManagementList = () => {
            const list = document.getElementById('gurubk-materi-list'), noMateri = document.getElementById('no-gurubk-materi');
            noMateri.classList.toggle('hidden', localMotivationalPosts.length > 0);

            list.innerHTML = localMotivationalPosts.map(post => `
                <div class="bg-sky-50 p-4 rounded-xl border border-sky-200 shadow-md">
                    <p class="font-bold text-lg text-gray-800">${post.title}</p>
                    <p class="text-sm text-gray-600 mt-1 line-clamp-2">${post.content}</p>
                    <p class="text-xs text-sky-500 mt-2">Oleh: ${post.author}</p>
                    <div class="mt-3 border-t border-gray-200 pt-3 flex gap-2">
                        <button onclick="editMateri('${post.id}')" class="btn-secondary bg-amber-500 text-gray-800 text-xs py-1.5 px-3 rounded-lg hover:bg-amber-600 flex items-center space-x-1 shadow-sm"><i data-lucide="edit-3" class="w-4 h-4"></i><span>Edit</span></button>
                        <button onclick="deleteMateri('${post.id}')" class="btn-secondary bg-red-500 text-white text-xs py-1.5 px-3 rounded-lg hover:bg-red-600 flex items-center space-x-1 shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Hapus</span></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        };

        document.getElementById('materi-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('materi-id').value;
            const title = document.getElementById('materi-title').value.trim();
            const content = document.getElementById('materi-content').value.trim();
            const author = guruBkProfile.fullName || 'Guru BK';

            if (id) {
                // Edit existing post
                const index = localMotivationalPosts.findIndex(p => p.id === id);
                if (index > -1) {
                    localMotivationalPosts[index] = { ...localMotivationalPosts[index], title, content, author };
                    showCustomModal('Perubahan Disimpan', 'Materi berhasil diperbarui.');
                }
            } else {
                // Add new post
                localMotivationalPosts.unshift({ id: `post_${Date.now()}`, title, content, author });
                showCustomModal('Materi Baru Ditambahkan', 'Materi baru berhasil ditambahkan dan siap dilihat siswa.');
            }
            
            saveDataToLocalStorage();
            renderMateriManagementList();
            renderMotivationalPosts(); // Update student view
            // Reset form
            e.target.reset();
            document.getElementById('materi-id').value = '';
            document.getElementById('materi-submit-btn').textContent = 'Tambah Materi';
            lucide.createIcons();
        });
        
        window.editMateri = (id) => {
            const post = localMotivationalPosts.find(p => p.id === id);
            if (post) {
                document.getElementById('materi-id').value = post.id;
                document.getElementById('materi-title').value = post.title;
                document.getElementById('materi-content').value = post.content;
                document.getElementById('materi-submit-btn').textContent = 'Simpan Perubahan';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.deleteMateri = (id) => {
            if (confirm('Apakah Anda yakin ingin menghapus materi ini?')) {
                localMotivationalPosts = localMotivationalPosts.filter(p => p.id !== id);
                saveDataToLocalStorage();
                renderMateriManagementList();
                renderMotivationalPosts();
                showCustomModal('Materi Dihapus', 'Materi berhasil dihapus.');
            }
        };


        // --- Admin Features (Laporan Siswa/Sistem) ---
        const renderAdminDashboard = () => {
            // Stats calculation
            const totalStudents = studentProfile ? 1 : 0; // Only tracking one local student
            const totalAppointments = localAppointments.length;
            const totalPending = localAppointments.filter(app => app.status === 'Pending').length;

            document.getElementById('stat-students').textContent = totalStudents;
            document.getElementById('stat-appointments').textContent = totalAppointments;
            document.getElementById('stat-pending').textContent = totalPending;
            
            // Render Users List
            const usersList = document.getElementById('admin-users-list');
            let allUsers = [];
            if (studentProfile) allUsers.push(studentProfile);
            if (guruBkProfile) allUsers.push(guruBkProfile);
            usersList.innerHTML = allUsers.length > 0 ? allUsers.map(user => `<div class="p-4 rounded-xl shadow-inner ${user.role === 'Siswa' ? 'bg-sky-50 border border-sky-200' : user.role === 'Guru BK' ? 'bg-amber-50 border border-amber-200' : 'bg-gray-100 border border-gray-300'} flex justify-between items-center"><div class="font-bold text-gray-800">${user.fullName}</div><div class="text-sm font-extrabold ${user.role === 'Siswa' ? 'text-sky-600' : user.role === 'Guru BK' ? 'text-amber-600' : 'text-gray-600'}">${user.role}</div></div>`).join('') : `<p class="text-gray-500 italic">Belum ada pengguna terdaftar.</p>`;

            // Render All Appointments
            const appointmentsList = document.getElementById('admin-all-appointments-list');
            appointmentsList.innerHTML = localAppointments.length > 0 ? localAppointments.map(app => `<div class="p-3 rounded-lg bg-gray-50 border border-gray-200 shadow-sm"><div class="flex justify-between items-center"><p class="font-semibold text-sm">${app.studentName} (${app.studentId})</p><span class="status-${app.status} px-2 py-0.5 text-xs font-semibold rounded-full">${app.status}</span></div><p class="text-xs text-gray-500 mt-1">${app.date} - ${app.time} | Alasan: ${app.reason.substring(0, 30)}...</p></div>`).join('') : `<p class="text-gray-500 italic">Belum ada janji temu dibuat.</p>`;
            lucide.createIcons();
        };

        window.viewSystemReport = () => {
            let reportText = "=== LAPORAN DETAIL SISTEM BK SEKOLAH ===\n\n";

            // 1. Data Siswa
            reportText += `1. DATA PROFIL SISWA (${studentProfile ? 1 : 0} Siswa Terdaftar):\n`;
            if (studentProfile) {
                reportText += `   - Nama Lengkap: ${studentProfile.fullName}\n`;
                reportText += `   - Sekolah: ${studentProfile.school}\n`;
                reportText += `   - Jurusan/Kelas: ${studentProfile.major}\n`;
                reportText += `   - ID (Lokal): ${studentProfile.id}\n`;
            } else {
                reportText += "   (Belum ada data siswa)\n";
            }
            reportText += "\n";

            // 2. Data Guru BK
            reportText += `2. DATA PROFIL GURU BK:\n`;
            if (guruBkProfile) {
                reportText += `   - Nama: ${guruBkProfile.fullName}\n`;
                reportText += `   - Telepon: ${guruBkProfile.phoneNumber}\n`;
            } else {
                reportText += "   (Belum ada data Guru BK)\n";
            }
            reportText += "\n";

            // 3. Data Janji Temu
            reportText += `3. DATA JANJI TEMU (${localAppointments.length} Total):\n`;
            if (localAppointments.length > 0) {
                localAppointments.forEach((app, index) => {
                    reportText += `   ${index + 1}. [${app.status}] ${app.studentName} (${app.date} ${app.time})\n`;
                    reportText += `      Alasan: ${app.reason}\n`;
                });
            } else {
                reportText += "   (Tidak ada janji temu)\n";
            }
            reportText += "\n";

            // 4. Data Materi
            reportText += `4. KONTEN MATERI MOTIVASI (${localMotivationalPosts.length} Total):\n`;
            if (localMotivationalPosts.length > 0) {
                localMotivationalPosts.forEach((post, index) => {
                    reportText += `   ${index + 1}. Judul: ${post.title}\n`;
                    reportText += `      Konten: ${post.content.substring(0, 50)}...\n`;
                });
            } else {
                reportText += "   (Tidak ada materi)\n";
            }
            reportText += "\n";

            // 5. Data Chat
            reportText += `5. STATISTIK CHAT (${localChatMessages.length} Total Pesan):\n`;
            const threads = getUniqueChatSenders();
            reportText += `   - Jumlah Thread Aktif (Siswa): ${threads.length}\n`;
            if (localChatMessages.length > 0) {
                 const userMsg = localChatMessages.filter(msg => msg.role === 'student').length;
                 const bkMsg = localChatMessages.filter(msg => msg.role === 'gurubk').length;
                 reportText += `   - Pesan Siswa: ${userMsg}, Pesan BK: ${bkMsg}\n`;
            } else {
                reportText += "   (Belum ada aktivitas chat)\n";
            }
            
            showCustomModal('Laporan Detail Sistem', `<pre class="text-xs text-left overflow-x-auto p-2 bg-gray-50 rounded-lg">${reportText}</pre>`);
        };


        // --- Initial Load ---
        function loadInitialStudentData() {
            renderMotivationalPosts();
            renderAppointments();
            renderChatMessages();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            document.getElementById('role-selector').classList.remove('hidden');
            lucide.createIcons();
            
             // Initialize default student ID if no profile exists
            if (!studentProfile) {
                userId = `local_student_${Date.now()}`;
            } else {
                userId = studentProfile.id; // Use saved ID
            }
        });
    </script>
</body>
</html>
