<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Konseling BK (Tema Sekolah)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Mengatur font default Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f7ff; /* Latar belakang lembut seperti kertas */
        }
        
        /* Styling untuk scrollbar yang lebih halus */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #93c5fd; /* Sky-300 */ border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #e0f2fe; /* Sky-100 */ }
        
        /* Efek klik pada tombol */
        .btn-primary:active, .btn-secondary:active { transform: scale(0.98); }
        
        /* Warna status janji temu */
        .status-Pending { @apply bg-yellow-100 text-yellow-800 font-bold; }
        .status-Confirmed { @apply bg-green-100 text-green-800 font-bold; }
        .status-Rejected { @apply bg-red-100 text-red-800 font-bold; }
        .status-Completed { @apply bg-sky-100 text-sky-800 font-bold; }

        /* Styling spesifik untuk chat */
        .chat-message-user { @apply bg-sky-500 text-white self-end rounded-bl-2xl rounded-t-2xl shadow-md; }
        .chat-message-bk { @apply bg-amber-100 text-gray-800 self-start rounded-br-2xl rounded-t-2xl shadow-md border border-amber-200; }
        
        /* Style untuk Role Selector: Gradien papan tulis/mading */
        #role-selector { background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Screen 1: Role Selector -->
    <div id="role-selector" class="absolute inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border-t-8 border-amber-400 transform hover:scale-[1.01] transition duration-300">
            <i data-lucide="compass" class="w-14 h-14 text-sky-600 mx-auto mb-4 animate-bounce"></i>
            <h2 class="text-4xl font-extrabold text-gray-800 mb-2">Pusat BK Digital</h2>
            <p class="text-gray-600 mb-8 font-medium">Bimbingan & Konseling Sekolah</p>
            
            <button onclick="setRoleAndLogin('student')" class="btn-primary w-full bg-sky-600 text-white font-extrabold py-4 rounded-xl shadow-lg hover:bg-sky-700 transition duration-150 mb-4 flex items-center justify-center space-x-2 text-lg">
                <i data-lucide="user-plus" class="w-6 h-6"></i>
                <span>Login Siswa (Pencari Bimbingan)</span>
            </button>
            
            <button onclick="setRoleAndLogin('gurubk')" class="btn-secondary w-full bg-amber-500 text-gray-900 font-extrabold py-4 rounded-xl shadow-lg hover:bg-amber-600 transition duration-150 mb-4 flex items-center justify-center space-x-2 text-lg">
                <i data-lucide="graduation-cap" class="w-6 h-6"></i>
                <span>Login Guru BK (Mentor)</span>
            </button>

            <button onclick="setRoleAndLogin('admin')" class="btn-secondary w-full bg-gray-800 text-white font-extrabold py-4 rounded-xl shadow-lg hover:bg-gray-900 transition duration-150 mt-4 flex items-center justify-center space-x-2 text-lg">
                <i data-lucide="shield" class="w-6 h-6"></i>
                <span>Login Admin (Pengelola Sistem)</span>
            </button>
            <p id="role-auth-status" class="text-xs text-gray-500 mt-6">Mode Online: Data disimpan di Supabase.</p>
        </div>
    </div>
    
    <!-- Data Forms for First Time Users -->
    <div id="student-data-form" class="absolute inset-0 z-40 flex items-center justify-center p-4 bg-sky-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border-t-8 border-sky-500">
             <i data-lucide="notebook-pen" class="w-12 h-12 text-sky-600 mx-auto mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Data Siswa</h2>
            <p class="text-gray-600 mb-8 text-center">Siapkan buku catatan Anda!</p>
            <form id="student-info-form">
                <div class="mb-4">
                    <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="student-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: Budi Sanjaya">
                </div>
                <div class="mb-4">
                    <label for="student-school" class="block text-sm font-medium text-gray-700 mb-1">Asal Sekolah</label>
                    <input type="text" id="student-school" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: SMAN 1 Dramaga">
                </div>
                <div class="mb-6">
                    <label for="student-major" class="block text-sm font-medium text-gray-700 mb-1">Jurusan / Kelas</label>
                    <input type="text" id="student-major" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: IPA 12 / RPL">
                </div>
                <button type="submit" class="btn-primary w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-sky-700 transition duration-150 flex items-center justify-center space-x-2 shadow-lg">
                    <i data-lucide="arrow-right-circle" class="w-5 h-5"></i><span>Mulai Belajar</span>
                </button>
            </form>
        </div>
    </div>

    <div id="gurubk-data-form" class="absolute inset-0 z-40 flex items-center justify-center p-4 bg-amber-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border-t-8 border-amber-500">
            <i data-lucide="user-cog" class="w-12 h-12 text-amber-600 mx-auto mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Data Guru BK</h2>
            <p class="text-gray-600 mb-8 text-center">Siap membimbing siswa.</p>
            <form id="gurubk-info-form">
                <div class="mb-4">
                    <label for="gurubk-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="gurubk-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 bg-amber-50" placeholder="Contoh: Ibu S.Pd">
                </div>
                <div class="mb-6">
                    <label for="gurubk-phone" class="block text-sm font-medium text-gray-700 mb-1">Nomor Telepon</label>
                    <input type="tel" id="gurubk-phone" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 bg-amber-50" placeholder="Contoh: 081234567890">
                </div>
                <button type="submit" class="btn-primary w-full bg-amber-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-amber-700 transition duration-150 flex items-center justify-center space-x-2 shadow-lg">
                    <i data-lucide="arrow-right-circle" class="w-5 h-5"></i><span>Masuk ke Panel Guru BK</span>
                </button>
            </form>
        </div>
    </div>
    
    <div id="admin-data-form" class="absolute inset-0 z-40 flex items-center justify-center p-4 bg-gray-100 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border-t-8 border-gray-800">
            <i data-lucide="server-cog" class="w-12 h-12 text-gray-800 mx-auto mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Data Admin</h2>
            <p class="text-gray-600 mb-8 text-center">Pengelola seluruh sistem.</p>
            <form id="admin-info-form">
                <div class="mb-6">
                    <label for="admin-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap Admin</label>
                    <input type="text" id="admin-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-gray-800 focus:border-gray-800 bg-gray-50" placeholder="Contoh: Pengelola Sistem">
                </div>
                <button type="submit" class="btn-primary w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-900 transition duration-150 flex items-center justify-center space-x-2 shadow-lg">
                    <i data-lucide="arrow-right-circle" class="w-5 h-5"></i><span>Masuk ke Panel Admin</span>
                </button>
            </form>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="main-app-container" class="flex flex-1 hidden">
        <nav id="mobile-nav" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-2xl z-20 md:hidden"></nav>
        <aside id="desktop-nav" class="hidden md:flex flex-col w-72 bg-white border-r border-gray-200 p-6 shadow-xl"></aside>

        <!-- Content Area -->
        <main class="flex-1 p-4 md:p-8 pb-20 md:pb-8 overflow-y-auto">
            
            <!-- Student View -->
            <div id="student-view" class="h-full w-full hidden">
                <!-- Tab: Materi Motivasi -->
                <div id="tab-materi" class="tab-content hidden">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-sky-400 pb-2">Materi Inspirasi</h2>
                    <p class="text-gray-600 mb-8 font-medium">Temukan semangat baru dan tips yang relevan untuk perkembangan akademik dan pribadi Anda.</p>
                    <div id="motivational-posts-list" class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3"></div>
                </div>

                <!-- Tab: Janji Temu BK -->
                <div id="tab-appointment" class="tab-content hidden">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-sky-400 pb-2">Jadwal Konseling</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-xl mb-8 border-t-8 border-amber-400">
                        <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center text-amber-600"><i data-lucide="calendar-plus" class="w-6 h-6 mr-2"></i>Buat Janji Baru</h3>
                        <form id="appointment-form">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="mb-4">
                                    <label for="appointment-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                    <input type="date" id="appointment-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50">
                                </div>
                                <div class="mb-4">
                                    <label for="appointment-time" class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
                                    <input type="time" id="appointment-time" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="appointment-reason" class="block text-sm font-medium text-gray-700 mb-1">Alasan Singkat Konseling</label>
                                <textarea id="appointment-reason" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: Kesulitan mengatur waktu belajar..."></textarea>
                            </div>
                            <button type="submit" class="btn-primary w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-sky-700 transition shadow-md">Kirim Permintaan</button>
                        </form>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-4 mt-8">Riwayat Janji Temu Saya</h3>
                    <div id="appointments-list" class="space-y-4">
                        <p id="no-appointments" class="text-gray-500 italic hidden">Belum ada janji temu.</p>
                    </div>
                </div>

                <!-- Tab: Chat Privasi -->
                <div id="tab-chat" class="tab-content hidden h-full flex flex-col">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-4 border-b-4 border-sky-400 pb-2">Ruang Chat Privasi</h2>
                    <p class="text-gray-600 mb-6 font-medium">Saluran rahasia Anda untuk berkomunikasi langsung dengan Guru BK.</p>
                    <div class="bg-amber-50 p-4 rounded-2xl shadow-md mb-6 border border-amber-200">
                         <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                            <div class="flex items-center">
                                <i data-lucide="phone-call" class="w-6 h-6 text-amber-600 mr-3"></i>
                                <div>
                                    <p class="text-sm font-semibold text-amber-700">Hubungi Cepat Guru BK (Nomor Contoh):</p>
                                    <a href="tel:+6285694009155" class="text-lg font-bold text-amber-800 hover:underline">085694009155</a>
                                </div>
                            </div>
                            <a href="https://wa.me/6285694009155" target="_blank" class="w-full sm:w-auto bg-amber-600 text-white font-bold py-2 px-4 rounded-xl hover:bg-amber-700 transition duration-150 flex items-center justify-center space-x-2 shadow-md">
                                <i data-lucide="message-square" class="w-4 h-4"></i><span>Chat di WhatsApp</span>
                            </a>
                        </div>
                    </div>
                    <div class="flex-1 bg-white p-4 rounded-2xl shadow-xl flex flex-col overflow-hidden h-[60vh] md:h-[70vh] border-2 border-sky-100">
                        <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 custom-scrollbar p-2"></div>
                        <form id="chat-form" class="mt-4 flex space-x-3">
                            <input type="text" id="chat-input" required placeholder="Tulis masukan, pertanyaan, atau keluhan Anda..." class="flex-1 p-3 border-2 border-sky-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50">
                            <button type="submit" class="btn-primary bg-sky-600 text-white p-3 rounded-xl hover:bg-sky-700 transition flex items-center justify-center shadow-md">
                                <i data-lucide="send" class="w-5 h-5"></i><span class="hidden sm:inline ml-2">Kirim</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Guru BK View -->
            <div id="gurubk-view" class="h-full w-full hidden">
                <h2 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-amber-400 pb-2">Panel Guru BK</h2>
                <div id="gurubk-content" class="h-full">
                    <!-- Tab: Antrean Janji Temu -->
                    <div id="tab-gurubk-appointments" class="gurubk-tab-content h-full hidden">
                         <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-amber-500">
                            <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center text-amber-700">
                                <i data-lucide="inbox" class="w-6 h-6 mr-2"></i>Antrean Janji Temu Masuk
                            </h3>
                            <div id="gurubk-appointments-list" class="space-y-4">
                                <p id="no-gurubk-appointments" class="text-gray-500 italic">Tidak ada janji temu baru.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Chat Siswa -->
                    <div id="tab-gurubk-chat" class="gurubk-tab-content hidden h-full flex flex-col">
                        <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-amber-500 flex-1">
                            <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center text-amber-700">
                                <i data-lucide="message-circle-more" class="w-6 h-6 mr-2"></i>Kotak Masuk Chat Siswa
                            </h3>
                            <div id="gurubk-chat-threads" class="space-y-3 max-h-[80vh] overflow-y-auto custom-scrollbar">
                                <p id="no-chat-threads" class="text-gray-500 italic">Belum ada pesan dari Siswa.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Kelola Materi -->
                    <div id="tab-gurubk-materi" class="gurubk-tab-content hidden">
                        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 border-t-8 border-sky-500">
                            <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center text-sky-700"><i data-lucide="book-open-text" class="w-6 h-6 mr-2"></i>Kelola Materi Motivasi</h3>
                            <form id="materi-form">
                                <input type="hidden" id="materi-id">
                                <div class="mb-4">
                                    <label for="materi-title" class="block text-sm font-medium text-gray-700 mb-1">Judul Materi</label>
                                    <input type="text" id="materi-title" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Contoh: 3 Kunci Fokus Belajar">
                                </div>
                                <div class="mb-6">
                                    <label for="materi-content" class="block text-sm font-medium text-gray-700 mb-1">Isi Materi</label>
                                    <textarea id="materi-content" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-50" placeholder="Tuliskan konten motivasi di sini..."></textarea>
                                </div>
                                <button type="submit" id="materi-submit-btn" class="btn-primary w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-sky-700 transition shadow-md">Tambah Materi</button>
                            </form>
                        </div>

                        <h3 class="text-3xl font-bold text-gray-800 mb-4 mt-8">Daftar Materi Aktif</h3>
                        <div id="gurubk-materi-list" class="space-y-4">
                            <p id="no-gurubk-materi" class="text-gray-500 italic">Belum ada materi yang dibuat.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="h-full w-full hidden">
                 <h2 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-gray-700 pb-2">Dashboard Admin Pengelola</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Kolom Pengguna Terdaftar -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-gray-700">
                        <h3 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"><i data-lucide="users" class="w-6 h-6 mr-2 text-gray-700"></i>Pengguna Terdaftar</h3>
                        <div id="admin-users-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar"></div>
                    </div>
                    <!-- Kolom Semua Janji Temu -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-gray-700">
                         <h3 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"><i data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-gray-700"></i>Seluruh Janji Temu</h3>
                         <div id="admin-all-appointments-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar"></div>
                    </div>
                 </div>
                 
                 <!-- Laporan Siswa / Sistem -->
                 <div class="mt-8 bg-white p-6 rounded-2xl shadow-2xl border-t-8 border-gray-800">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><i data-lucide="book-text" class="w-6 h-6 mr-2 text-gray-800"></i>Laporan & Statistik Sistem</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-sky-50 rounded-xl text-center shadow-inner"><p class="text-3xl font-extrabold text-sky-800" id="stat-students">0</p><p class="text-sm text-sky-600 font-semibold">Total Siswa</p></div>
                        <div class="p-4 bg-amber-50 rounded-xl text-center shadow-inner"><p class="text-3xl font-extrabold text-amber-800" id="stat-appointments">0</p><p class="text-sm text-amber-600 font-semibold">Total Janji</p></div>
                        <div class="p-4 bg-yellow-50 rounded-xl text-center shadow-inner"><p class="text-3xl font-extrabold text-yellow-800" id="stat-pending">0</p><p class="text-sm text-yellow-600 font-semibold">Janji Tertunda</p></div>
                    </div>
                    <button onclick="viewSystemReport()" class="btn-primary w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-800 transition flex items-center justify-center space-x-2 shadow-md">
                        <i data-lucide="download" class="w-5 h-5"></i><span>Lihat Laporan Detail Siswa</span>
                    </button>
                 </div>
            </div>

            <!-- Custom Modal -->
            <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full border-t-8 border-sky-500">
                    <h3 id="modal-title" class="text-2xl font-bold mb-3 text-sky-700 flex items-center"><i data-lucide="bell" class="w-6 h-6 mr-2"></i>Notifikasi</h3>
                    <div id="modal-message" class="text-gray-600 mb-5 overflow-y-auto max-h-64 whitespace-pre-wrap text-sm border-b pb-3"></div>
                    <button id="modal-close-btn" class="w-full bg-sky-600 text-white font-bold py-3 rounded-xl hover:bg-sky-700 shadow-md">Tutup</button>
                </div>
            </div>

             <!-- Chat View/Reply Modal for Guru BK -->
            <div id="chat-reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full h-[90vh] flex flex-col border-t-8 border-amber-500">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-2xl font-bold text-amber-700">Chat dengan <span id="chat-reply-student-name"></span></h3>
                        <button onclick="closeChatReplyModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div id="gurubk-specific-chat-messages" class="flex-1 overflow-y-auto space-y-4 custom-scrollbar p-2 mb-4 bg-sky-50 rounded-xl border border-sky-200">
                        <!-- Messages render here -->
                    </div>
                    
                    <form id="gurubk-chat-reply-form" class="flex space-x-3">
                        <input type="text" id="gurubk-chat-reply-input" required placeholder="Balas pesan siswa (seperti menggunakan pena)..." class="flex-1 p-3 border-2 border-amber-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 bg-amber-50">
                        <button type="submit" class="btn-primary bg-amber-600 text-white p-3 rounded-xl hover:bg-amber-700 transition flex items-center justify-center shadow-md">
                            <i data-lucide="send" class="w-5 h-5"></i><span class="hidden sm:inline ml-2">Balas</span>
                        </button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <!-- App Logic with Supabase -->
    <script>
        // --- Koneksi ke Supabase ---
        // PENTING: Ganti nilai di bawah ini dengan URL dan Kunci Anon dari dashboard Supabase Anda.
        const SUPABASE_URL = 'https://bpquystzpzmwezpephaf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwcXV5c3R6cHptd2V6cGVwaGFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMjM4MjQsImV4cCI6MjA3NjU5OTgyNH0.CGLIirF-HypP4yjsJqy2tagPhm4AQaQpxuvZ7JbfovE';

        // Inisialisasi Supabase Client
        let supabase; // Variabel untuk menyimpan instance klien Supabase
        try {
            // Kita akan mencoba menginisialisasi klien Supabase terlepas dari nilai default,
            // selama URL dan Kunci ada, untuk memungkinkan pengguna masuk dalam mode simulasi.
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                // MENGAKSES FUNGSI createClient DARI OBJEK GLOBAL
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                 console.warn("Supabase credentials not fully provided. App will run in a limited state.");
            }
        } catch(e) {
            console.error("Error initializing Supabase client:", e);
        }

        // --- Global State ---
        let userRole = null; 
        let userProfile = null;
        let userId = localStorage.getItem('bkApp_userId'); // Get user ID from local storage to persist session
        let currentChatStudentId = null; // For Guru BK chat reply
        
        // --- Utility Functions ---
        function showCustomModal(title, message) { 
            document.getElementById('modal-title').innerHTML = `<i data-lucide="${title.toLowerCase().includes('gagal') ? 'alert-triangle' : 'check-circle'}" class="w-6 h-6 mr-2"></i>${title}`;
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('custom-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        document.getElementById('modal-close-btn').onclick = () => document.getElementById('custom-modal').classList.add('hidden');
        function closeChatReplyModal() { document.getElementById('chat-reply-modal').classList.add('hidden'); currentChatStudentId = null; }
        window.closeChatReplyModal = closeChatReplyModal;
        
        function returnToRoleSelector() { 
            localStorage.removeItem('bkApp_userId');
            localStorage.removeItem('bkApp_userRole');
            localStorage.removeItem('bkApp_userId_student');
            localStorage.removeItem('bkApp_userId_gurubk');
            localStorage.removeItem('bkApp_userId_admin');
            window.location.reload(); 
        }
        window.returnToRoleSelector = returnToRoleSelector;

        // --- Display Info Updaters ---
        const updateDisplayInfo = () => {
            if (!userProfile) return;
            // Ini akan membutuhkan elemen display yang belum ada di HTML, biarkan sebagai placeholder.
            // if (userRole === 'student') document.getElementById('user-name-display').textContent = userProfile.full_name;
            // if (userRole === 'gurubk') document.getElementById('gurubk-name-display').textContent = userProfile.full_name;
            // if (userRole === 'admin') document.getElementById('admin-name-display').textContent = userProfile.full_name;
        };

        // --- Role & View Management ---
        async function proceedToApp() {
            ['role-selector', 'student-data-form', 'gurubk-data-form', 'admin-data-form'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('main-app-container').classList.remove('hidden');
            ['student-view', 'gurubk-view', 'admin-view'].forEach(id => document.getElementById(id).classList.add('hidden'));

            if (userRole === 'student') {
                document.getElementById('student-view').classList.remove('hidden');
                loadStudentLayout();
                await loadInitialStudentData();
            } else if (userRole === 'gurubk') {
                document.getElementById('gurubk-view').classList.remove('hidden');
                loadGuruBkLayout();
                await loadInitialGuruBkData();
            } else if (userRole === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                loadAdminLayout();
                await renderAdminDashboard();
            }
            
            updateDisplayInfo();
            // document.getElementById('auth-status').textContent = `Status: Terhubung (${userRole.toUpperCase()})`; // Elemen ini juga belum ada
            lucide.createIcons();
        }

        async function setRoleAndLogin(role) {
            userRole = role;
            
            // FIX: Mengganti simulasi ID berbasis timestamp dengan UUID yang valid untuk Supabase
            let roleSpecificId = localStorage.getItem(`bkApp_userId_${role}`);
            if (!roleSpecificId) {
                // Generate a proper UUID structure for Supabase ID compatibility
                roleSpecificId = crypto.randomUUID(); 
            }
            
            userId = roleSpecificId;
            localStorage.setItem(`bkApp_userId_${role}`, userId);
            localStorage.setItem('bkApp_userId', userId);
            localStorage.setItem('bkApp_userRole', role);

            // Cek di sini, Supabase client harus sudah terinisialisasi
            if (!supabase) {
                showCustomModal('Koneksi Gagal', 'Supabase Client gagal diinisialisasi. Periksa kembali URL dan Kunci API Anda, atau coba muat ulang halaman.');
                return;
            }

            // Gunakan userId (UUID yang valid) untuk query
            const { data, error } = await supabase.from('profiles').select('*').eq('id', userId).single();
            if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                 console.error("Error fetching profile:", error);
                 // Tampilkan pesan kesalahan hanya jika itu bukan kesalahan 'not found'
                 if (error.code !== 'PGRST116') { 
                     showCustomModal('Error', `Gagal mengambil data profil dari database. Error Code: ${error.code}`);
                 }
                 return;
            }
            
            userProfile = data;

            if (userProfile) {
                await proceedToApp();
            } else {
                document.getElementById('role-selector').classList.add('hidden');
                document.getElementById(`${role}-data-form`).classList.remove('hidden');
                lucide.createIcons();
            }
        }
        window.setRoleAndLogin = setRoleAndLogin;
        
        // --- Navigation Logic (Dummy) ---
        function navigateToTab(tabId, viewId) {
            document.querySelectorAll(`#${viewId} .tab-content, #${viewId} .gurubk-tab-content`).forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll(`#mobile-nav button, #desktop-nav button`).forEach(btn => btn.classList.remove('bg-sky-500', 'text-white', 'bg-amber-500', 'text-gray-900'));
            
            const roleClass = userRole === 'student' ? 'bg-sky-500 text-white' : 'bg-amber-500 text-gray-900';
            // FIX: The classList.add method does not support adding multiple classes in one string.
            // We need to split the string into an array and spread it as arguments.
            const classesToAdd = roleClass.split(' ');
            document.querySelector(`[data-tab="${tabId}"]`)?.classList.add(...classesToAdd);
            lucide.createIcons();
        }
        window.navigateToTab = navigateToTab;

        // --- Layout Loaders ---
        function loadStudentLayout() {
            const navItems = [
                { id: 'tab-materi', icon: 'book-open', label: 'Materi' },
                { id: 'tab-appointment', icon: 'calendar-check', label: 'Janji Temu' },
                { id: 'tab-chat', icon: 'message-square', label: 'Chat' },
            ];
            
            const createNavHtml = (item, isDesktop) => `
                <button onclick="navigateToTab('${item.id}', 'student-view')" data-tab="${item.id}" class="w-full flex ${isDesktop ? 'items-center space-x-3 p-3 text-lg rounded-xl hover:bg-sky-50' : 'flex-col items-center justify-center p-2 text-xs transition duration-150'} text-gray-600">
                    <i data-lucide="${item.icon}" class="${isDesktop ? 'w-6 h-6' : 'w-5 h-5'}"></i>
                    <span class="${isDesktop ? 'font-medium' : 'mt-1'}">${item.label}</span>
                </button>
            `;

            document.getElementById('mobile-nav').innerHTML = navItems.map(item => createNavHtml(item, false)).join('');
            document.getElementById('desktop-nav').innerHTML = `
                <div class="flex flex-col space-y-2 mt-4">
                    ${navItems.map(item => createNavHtml(item, true)).join('')}
                </div>
                <div class="mt-auto pt-6 border-t border-gray-200">
                    <button onclick="returnToRoleSelector()" class="w-full flex items-center space-x-3 p-3 text-lg rounded-xl text-red-600 hover:bg-red-50">
                        <i data-lucide="log-out" class="w-6 h-6"></i>
                        <span class="font-medium">Keluar</span>
                    </button>
                </div>
            `;
            navigateToTab('tab-materi', 'student-view');
        }

        function loadGuruBkLayout() {
             const navItems = [
                { id: 'tab-gurubk-appointments', icon: 'calendar-plus', label: 'Janji Temu' },
                { id: 'tab-gurubk-chat', icon: 'message-circle', label: 'Kotak Masuk' },
                { id: 'tab-gurubk-materi', icon: 'list-checks', label: 'Kelola Materi' },
            ];
            
            const createNavHtml = (item, isDesktop) => `
                <button onclick="navigateToTab('${item.id}', 'gurubk-view')" data-tab="${item.id}" class="w-full flex ${isDesktop ? 'items-center space-x-3 p-3 text-lg rounded-xl hover:bg-amber-50' : 'flex-col items-center justify-center p-2 text-xs transition duration-150'} text-gray-600">
                    <i data-lucide="${item.icon}" class="${isDesktop ? 'w-6 h-6' : 'w-5 h-5'}"></i>
                    <span class="${isDesktop ? 'font-medium' : 'mt-1'}">${item.label}</span>
                </button>
            `;

            document.getElementById('mobile-nav').innerHTML = navItems.map(item => createNavHtml(item, false)).join('');
            document.getElementById('desktop-nav').innerHTML = `
                <div class="flex flex-col space-y-2 mt-4">
                    ${navItems.map(item => createNavHtml(item, true)).join('')}
                </div>
                <div class="mt-auto pt-6 border-t border-gray-200">
                    <button onclick="returnToRoleSelector()" class="w-full flex items-center space-x-3 p-3 text-lg rounded-xl text-red-600 hover:bg-red-50">
                        <i data-lucide="log-out" class="w-6 h-6"></i>
                        <span class="font-medium">Keluar</span>
                    </button>
                </div>
            `;
            navigateToTab('tab-gurubk-appointments', 'gurubk-view');
        }

        function loadAdminLayout() {
             const navItems = [
                { id: 'admin-view', icon: 'layout-dashboard', label: 'Dashboard' } // Admin view is one page
            ];
            
            const createNavHtml = (item, isDesktop) => `
                <button onclick="navigateToTab('${item.id}', 'admin-view')" data-tab="${item.id}" class="w-full flex ${isDesktop ? 'items-center space-x-3 p-3 text-lg rounded-xl hover:bg-gray-100' : 'flex-col items-center justify-center p-2 text-xs transition duration-150'} text-gray-600">
                    <i data-lucide="${item.icon}" class="${isDesktop ? 'w-6 h-6' : 'w-5 h-5'}"></i>
                    <span class="${isDesktop ? 'font-medium' : 'mt-1'}">${item.label}</span>
                </button>
            `;

            document.getElementById('mobile-nav').innerHTML = navItems.map(item => createNavHtml(item, false)).join('');
            document.getElementById('desktop-nav').innerHTML = `
                <div class="flex flex-col space-y-2 mt-4">
                    ${navItems.map(item => createNavHtml(item, true)).join('')}
                </div>
                <div class="mt-auto pt-6 border-t border-gray-200">
                    <button onclick="returnToRoleSelector()" class="w-full flex items-center space-x-3 p-3 text-lg rounded-xl text-red-600 hover:bg-red-50">
                        <i data-lucide="log-out" class="w-6 h-6"></i>
                        <span class="font-medium">Keluar</span>
                    </button>
                </div>
            `;
            // Admin only has one main view, so it's always visible after login
        }
        
        // --- Data Form Handling (diubah untuk Supabase) ---
        document.getElementById('student-info-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProfile = { id: userId, full_name: document.getElementById('student-name').value.trim(), school: document.getElementById('student-school').value.trim(), major: document.getElementById('student-major').value.trim(), role: 'Siswa' };
            
            const { data, error } = await supabase.from('profiles').insert(newProfile).select().single();
            if (error) { console.error("Error creating student profile:", error); showCustomModal('Gagal Registrasi', 'Terjadi kesalahan saat menyimpan data profil.'); return; }
            
            userProfile = data;
            await proceedToApp();
        });

        document.getElementById('gurubk-info-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProfile = { id: userId, full_name: document.getElementById('gurubk-name').value.trim(), phone_number: document.getElementById('gurubk-phone').value.trim(), role: 'Guru BK' };
            const { data, error } = await supabase.from('profiles').insert(newProfile).select().single();
            if (error) { console.error("Error creating BK profile:", error); showCustomModal('Gagal Registrasi', 'Terjadi kesalahan saat menyimpan data profil.'); return; }
            userProfile = data;
            await proceedToApp();
        });
        
        document.getElementById('admin-info-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProfile = { id: userId, full_name: document.getElementById('admin-name').value.trim(), role: 'Admin' };
             const { data, error } = await supabase.from('profiles').insert(newProfile).select().single();
            if (error) { console.error("Error creating Admin profile:", error); showCustomModal('Gagal Registrasi', 'Terjadi kesalahan saat menyimpan data profil.'); return; }
            userProfile = data;
            await proceedToApp();
        });
        
        // --- Student Features (diubah untuk Supabase) ---
        async function loadInitialStudentData() {
            await fetchAndRenderMotivationalPosts();
            await fetchAndRenderAppointments();
            // Tidak perlu render chat secara eksplisit, karena sudah ada listener realtime
        }
        
        async function fetchAndRenderMotivationalPosts() {
            const { data, error } = await supabase.from('motivational_posts').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Error fetching posts:', error); return; }
            document.getElementById('motivational-posts-list').innerHTML = data.map(post => `<div class="bg-white p-6 rounded-2xl shadow-xl border-l-8 border-sky-400 hover:shadow-2xl transition duration-200"><h4 class="text-xl font-bold text-gray-800 mb-2">${post.title}</h4><p class="text-gray-600 mb-4 line-clamp-3">${post.content}</p><p class="text-xs text-sky-500 font-medium flex items-center"><i data-lucide="user-check" class="w-4 h-4 mr-1"></i>Oleh: ${post.author}</p></div>`).join('');
            lucide.createIcons();
        }
        
        document.getElementById('appointment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newAppointment = { date: document.getElementById('appointment-date').value, time: document.getElementById('appointment-time').value, reason: document.getElementById('appointment-reason').value.trim(), student_id: userId, student_name: userProfile.full_name };
            const { error } = await supabase.from('appointments').insert(newAppointment);
            if (error) { console.error('Error creating appointment:', error); showCustomModal('Gagal', 'Gagal mengirim permintaan.'); return; }
            showCustomModal('Permintaan Terkirim!', 'Permintaan janji temu Anda berhasil dicatat. Guru BK akan segera mengonfirmasi jadwal Anda.');
            e.target.reset();
        });

        async function fetchAndRenderAppointments() {
            const list = document.getElementById('appointments-list'), noApps = document.getElementById('no-appointments');
            const { data, error } = await supabase.from('appointments').select('*').eq('student_id', userId).order('date', { ascending: false });
            if (error) { console.error('Error fetching appointments:', error); return; }
            
            noApps.classList.toggle('hidden', data.length > 0);
            list.innerHTML = data.map(app => `<div class="bg-white p-4 rounded-xl shadow-md border-l-8 ${app.status === 'Confirmed' ? 'border-green-500' : app.status === 'Rejected' ? 'border-red-500' : 'border-yellow-500'}"><div class="flex justify-between items-start"><p class="font-bold text-gray-800 text-lg">${app.date} Pukul ${app.time}</p><span class="status-${app.status} px-3 py-1 text-xs font-semibold rounded-full">${app.status}</span></div><p class="text-sm text-gray-600 mt-2">Alasan: ${app.reason}</p><p class="text-xs text-gray-400 mt-2">Diajukan: ${new Date(app.created_at).toLocaleDateString('id-ID', { hour: '2-digit', minute: '2-digit' })}</p></div>`).join('');
        };
        
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const chatInput = document.getElementById('chat-input');
            if (!chatInput.value.trim()) return;
            const newMessage = { sender_id: userId, sender_name: userProfile.full_name, message: chatInput.value.trim(), role: 'student' };
            // Tambahkan recipient_id ke pesan jika ingin diarahkan ke guru BK tertentu, untuk saat ini biarkan null
            const { error } = await supabase.from('chat_messages').insert(newMessage);
            if (error) { console.error('Error sending message:', error); return; }
            chatInput.value = '';
        });

        async function renderChatMessages() {
            // Dalam mode Siswa, hanya tampilkan pesan antara Siswa ini dan Guru BK (atau pesan yang tidak memiliki recipient_id)
            const { data, error } = await supabase.from('chat_messages').select('*').or(`sender_id.eq.${userId},recipient_id.eq.${userId}`).order('created_at');
            if (error) { console.error('Error fetching chat:', error); return; }

            const list = document.getElementById('chat-messages');
            list.innerHTML = data.map(msg => {
                const isUser = msg.sender_id === userId; 
                const timestamp = new Date(msg.created_at).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                return `<div class="max-w-[85%] ${isUser ? 'chat-message-user ml-auto' : 'chat-message-bk mr-auto'} p-3 text-sm"><p>${!isUser ? `<span class="font-bold">Guru BK</span>: ` : ''}${msg.message}</p><p class="text-xs ${isUser ? 'text-sky-100' : 'text-amber-500'} text-right mt-1">${timestamp}</p></div>`;
            }).join('');
            list.scrollTop = list.scrollHeight;
        };
        
        // --- Guru BK Features (diubah untuk Supabase) ---
        async function loadInitialGuruBkData() {
            await fetchAndRenderGuruBkAppointments();
            await fetchAndRenderGurubkChatThreads();
            await fetchAndRenderMateriManagementList();
            listenToAllChanges(); // Pindah listener ke sini dan Initial Load
        }

        window.updateAppointmentStatus = async (docId, newStatus) => {
            const { error } = await supabase.from('appointments').update({ status: newStatus }).eq('id', docId);
            if (error) { console.error('Error updating status:', error); return; }
            showCustomModal('Aksi Berhasil', `Status Janji Temu diperbarui menjadi **${newStatus}**.`);
        };

        async function fetchAndRenderGuruBkAppointments() { 
            const list = document.getElementById('gurubk-appointments-list'), noApps = document.getElementById('no-gurubk-appointments');
            // Ambil semua janji temu, dan pisahkan yang masih pending untuk diletakkan di atas
            const { data, error } = await supabase.from('appointments').select('*').order('status', { ascending: true }).order('created_at', { ascending: false });
            if (error) { console.error('Error fetching BK appointments:', error); return; }
            
            noApps.classList.toggle('hidden', data.length > 0);
            
            list.innerHTML = data.map(app => {
                const isPending = app.status === 'Pending';
                // Gunakan properti 'id' yang merupakan integer atau UUID untuk tombol update
                return `<div class="bg-white p-4 rounded-xl shadow-md border-l-8 ${isPending ? 'border-yellow-500' : app.status === 'Confirmed' ? 'border-green-500' : app.status === 'Rejected' ? 'border-red-500' : 'border-sky-500'} ${isPending ? 'border-2 border-yellow-200' : ''}">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-gray-800 text-lg">${app.student_name} (${app.status})</p>
                        <span class="status-${app.status} px-3 py-1 text-xs font-semibold rounded-full">${app.status}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Waktu: ${app.date} Pukul ${app.time}</p>
                    <p class="text-sm text-gray-600">Alasan: ${app.reason}</p>
                    ${isPending ? 
                        `<div class="flex space-x-2 mt-3">
                            <button onclick="updateAppointmentStatus('${app.id}', 'Confirmed')" class="btn-primary bg-green-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-green-600 transition">Konfirmasi</button>
                            <button onclick="updateAppointmentStatus('${app.id}', 'Rejected')" class="btn-secondary bg-red-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-red-600 transition">Tolak</button>
                        </div>` : ''}
                </div>`;
            }).join('');
        }

        async function openChatReplyModal(studentId, studentName) {
            currentChatStudentId = studentId;
            document.getElementById('chat-reply-student-name').textContent = studentName;

            // 1. Ambil pesan chat spesifik
            const { data, error } = await supabase.from('chat_messages').select('*').or(`sender_id.eq.${studentId},recipient_id.eq.${studentId}`).order('created_at');
            if (error) { console.error('Error fetching specific chat:', error); return; }

            // 2. Render pesan
            const list = document.getElementById('gurubk-specific-chat-messages');
            list.innerHTML = data.map(msg => {
                const isUser = msg.sender_id === studentId;
                const roleLabel = isUser ? msg.sender_name : 'Anda (Guru BK)'; 
                const timestamp = new Date(msg.created_at).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                
                return `<div class="max-w-[85%] ${isUser ? 'chat-message-user ml-auto' : 'chat-message-bk mr-auto'} p-3 text-sm">
                    <p class="font-semibold mb-1">${roleLabel}</p>
                    <p>${msg.message}</p>
                    <p class="text-xs ${isUser ? 'text-sky-100' : 'text-amber-500'} text-right mt-1">${timestamp}</p>
                </div>`;
            }).join('');
            list.scrollTop = list.scrollHeight;
            lucide.createIcons();
            document.getElementById('chat-reply-modal').classList.remove('hidden');
        }
        window.openChatReplyModal = openChatReplyModal;

        document.getElementById('gurubk-chat-reply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const replyInput = document.getElementById('gurubk-chat-reply-input');
            if (!replyInput.value.trim() || !currentChatStudentId) return;

            const newMessage = { 
                sender_id: userId, 
                sender_name: userProfile.full_name, 
                message: replyInput.value.trim(), 
                role: 'gurubk', 
                recipient_id: currentChatStudentId // Kirim balasan ke Siswa yang sedang chatting
            };
            
            const { error } = await supabase.from('chat_messages').insert(newMessage);
            if (error) { console.error('Error sending reply:', error); return; }
            
            replyInput.value = '';
            // Refresh modal untuk menampilkan pesan baru
            openChatReplyModal(currentChatStudentId, document.getElementById('chat-reply-student-name').textContent);
        });

        async function fetchAndRenderGurubkChatThreads() {
            // Dapatkan semua pesan untuk mengelompokkannya berdasarkan pengirim
            const { data, error } = await supabase.from('chat_messages').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Error fetching chat threads:', error); return; }

            const threadsMap = {};
            data.forEach(msg => {
                const threadId = msg.role === 'student' ? msg.sender_id : msg.recipient_id;
                const studentName = msg.role === 'student' ? msg.sender_name : (msg.recipient_id === userId ? msg.sender_name : 'Siswa Lain');

                if (!threadsMap[threadId]) {
                    threadsMap[threadId] = {
                        student_id: threadId,
                        student_name: studentName,
                        last_message: msg.message,
                        last_message_time: new Date(msg.created_at),
                        is_new: msg.role === 'student' // Asumsi pesan dari siswa adalah 'baru'
                    };
                }
            });

            const threads = Object.values(threadsMap).sort((a, b) => b.last_message_time - a.last_message_time);
            const list = document.getElementById('gurubk-chat-threads');
            const noThreads = document.getElementById('no-chat-threads');
            
            noThreads.classList.toggle('hidden', threads.length > 0);
            
            list.innerHTML = threads.map(thread => `
                <div onclick="openChatReplyModal('${thread.student_id}', '${thread.student_name}')" class="bg-white p-4 rounded-xl shadow-md border-l-8 border-amber-400 hover:bg-amber-50 cursor-pointer transition">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-gray-800 text-lg">${thread.student_name}</p>
                        <span class="text-xs text-gray-500">${thread.last_message_time.toLocaleDateString('id-ID')}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1 line-clamp-1">${thread.last_message}</p>
                </div>
            `).join('');
        }
        
        document.getElementById('materi-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('materi-id').value;
            const title = document.getElementById('materi-title').value.trim();
            const content = document.getElementById('materi-content').value.trim();
            
            const postData = { title, content, author: userProfile.full_name };
            
            let error;
            if (id) {
                // Edit
                ({ error } = await supabase.from('motivational_posts').update(postData).eq('id', id));
                showCustomModal('Berhasil', 'Materi berhasil diperbarui!');
            } else {
                // Tambah Baru
                ({ error } = await supabase.from('motivational_posts').insert(postData));
                showCustomModal('Berhasil', 'Materi baru berhasil ditambahkan!');
            }

            if (error) { console.error('Error saving materi:', error); showCustomModal('Gagal', 'Gagal menyimpan materi.'); return; }
            e.target.reset();
            document.getElementById('materi-id').value = '';
            document.getElementById('materi-submit-btn').textContent = 'Tambah Materi';
        });

        window.editMateri = (id, title, content) => {
            // Mengganti quotes agar aman dimasukkan ke string HTML
            const safeTitle = title.replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeContent = content.replace(/'/g, "\\'").replace(/"/g, '\\"');

            document.getElementById('materi-id').value = id;
            document.getElementById('materi-title').value = safeTitle;
            document.getElementById('materi-content').value = safeContent;
            document.getElementById('materi-submit-btn').textContent = 'Perbarui Materi';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        window.deleteMateri = async (id) => {
            // Gunakan modal kustom daripada confirm()
            showCustomModal('Konfirmasi Hapus', `Anda yakin ingin menghapus materi ID: **${id}**?`, true); // Tanda true untuk konfirmasi
            document.getElementById('modal-close-btn').textContent = 'Batalkan';
            
            const deleteAction = async () => {
                const { error } = await supabase.from('motivational_posts').delete().eq('id', id);
                document.getElementById('modal-close-btn').onclick = () => document.getElementById('custom-modal').classList.add('hidden'); // Reset close action
                if (error) { console.error('Error deleting materi:', error); showCustomModal('Gagal', 'Gagal menghapus materi.'); return; }
                showCustomModal('Berhasil', 'Materi berhasil dihapus!');
            };
            
            // Tambahkan tombol konfirmasi
            const modalMessageEl = document.getElementById('modal-message');
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Ya, Hapus';
            confirmBtn.className = 'w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 shadow-md mt-3';
            confirmBtn.onclick = () => { deleteAction(); document.getElementById('custom-modal').classList.add('hidden'); };
            
            const closeBtn = document.getElementById('modal-close-btn');
            closeBtn.parentNode.insertBefore(confirmBtn, closeBtn);
            closeBtn.onclick = () => { confirmBtn.remove(); document.getElementById('custom-modal').classList.add('hidden'); };
        };

        async function fetchAndRenderMateriManagementList() {
            const list = document.getElementById('gurubk-materi-list'), noMateri = document.getElementById('no-gurubk-materi');
            const { data, error } = await supabase.from('motivational_posts').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Error fetching management posts:', error); return; }
            
            noMateri.classList.toggle('hidden', data.length > 0);
            
            list.innerHTML = data.map(post => {
                // Sanitasi konten untuk mencegah kerusakan string pada pemanggilan fungsi
                const safeTitle = post.title.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const safeContent = post.content.replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                return `<div class="bg-white p-4 rounded-xl shadow-md border-l-8 border-sky-400">
                    <h4 class="text-xl font-bold text-gray-800 mb-1">${post.title}</h4>
                    <p class="text-gray-600 text-sm line-clamp-2">${post.content}</p>
                    <div class="flex space-x-2 mt-3">
                        <button onclick="editMateri(${post.id}, '${safeTitle}', '${safeContent}')" class="btn-primary bg-sky-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-sky-600 transition flex items-center"><i data-lucide="pen-tool" class="w-4 h-4 mr-1"></i>Edit</button>
                        <button onclick="deleteMateri(${post.id})" class="btn-secondary bg-red-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-red-600 transition flex items-center"><i data-lucide="trash-2" class="w-4 h-4 mr-1"></i>Hapus</button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- Admin Features ---
        async function renderAdminDashboard() {
            const { data: profiles, error: err1 } = await supabase.from('profiles').select('*');
            const { data: appointments, error: err2 } = await supabase.from('appointments').select('*');
            
            if (err1 || err2) { console.error("Error fetching admin data:", err1 || err2); return; }

            // Statistik
            const students = profiles.filter(p => p.role === 'Siswa').length;
            const totalAppointments = appointments.length;
            const pendingAppointments = appointments.filter(a => a.status === 'Pending').length;
            
            document.getElementById('stat-students').textContent = students;
            document.getElementById('stat-appointments').textContent = totalAppointments;
            document.getElementById('stat-pending').textContent = pendingAppointments;

            // Daftar Pengguna
            const userListHtml = profiles.map(p => `
                <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-semibold text-gray-800">${p.full_name}</p>
                        <p class="text-sm text-gray-500">${p.role}</p>
                    </div>
                    <span class="text-xs font-mono text-gray-400">${p.id.substring(0, 8)}...</span>
                </div>
            `).join('');
            document.getElementById('admin-users-list').innerHTML = userListHtml;

            // Daftar Semua Janji Temu
            const allAppsListHtml = appointments.map(app => `
                 <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 ${app.status === 'Confirmed' ? 'border-green-500' : app.status === 'Rejected' ? 'border-red-500' : 'border-yellow-500'}">
                    <p class="font-bold text-gray-800 text-sm">${app.student_name} (<span class="status-${app.status} text-xs font-semibold rounded-full">${app.status}</span>)</p>
                    <p class="text-xs text-gray-600">Pada: ${app.date} Pukul ${app.time}</p>
                </div>
            `).join('');
            document.getElementById('admin-all-appointments-list').innerHTML = allAppsListHtml;

            lucide.createIcons();
        }
        
        window.viewSystemReport = () => {
             showCustomModal('Laporan Sistem', 'Fitur laporan detail (export data) akan dikembangkan lebih lanjut! Saat ini Anda dapat melihat statistik di Dashboard.');
        };


        // --- Realtime Subscriptions ---
        function listenToAllChanges() {
             supabase.channel('public:appointments').on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, payload => {
                if(userRole === 'student') fetchAndRenderAppointments();
                if(userRole === 'gurubk') fetchAndRenderGuruBkAppointments();
                if(userRole === 'admin') renderAdminDashboard();
            }).subscribe();

            supabase.channel('public:chat_messages').on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, payload => {
                if(userRole === 'student') renderChatMessages();
                if(userRole === 'gurubk') {
                    if (currentChatStudentId) {
                        // Refresh modal jika Guru BK sedang berada di chat ini
                        const studentName = document.getElementById('chat-reply-student-name').textContent;
                        openChatReplyModal(currentChatStudentId, studentName);
                    }
                    fetchAndRenderGurubkChatThreads();
                }
            }).subscribe();
            
            supabase.channel('public:motivational_posts').on('postgres_changes', { event: '*', schema: 'public', table: 'motivational_posts' }, payload => {
                if(userRole === 'student') fetchAndRenderMotivationalPosts();
                if(userRole === 'gurubk') fetchAndRenderMateriManagementList();
            }).subscribe();
            
            // Listener untuk perubahan profil (misalnya, registrasi baru)
            supabase.channel('public:profiles').on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, payload => {
                if(userRole === 'admin') renderAdminDashboard();
            }).subscribe();
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Restore session if exists
            const savedRole = localStorage.getItem('bkApp_userRole');
            const savedId = localStorage.getItem('bkApp_userId');
            
            if (savedRole && savedId && supabase) {
                userRole = savedRole;
                userId = savedId;
                const { data } = await supabase.from('profiles').select('*').eq('id', userId).single();
                userProfile = data;
                if (userProfile) {
                    await proceedToApp();
                } else {
                     document.getElementById('role-selector').classList.remove('hidden');
                }
            } else {
                 document.getElementById('role-selector').classList.remove('hidden');
            }
            lucide.createIcons();

            if(supabase) {
                listenToAllChanges();
            } else {
                 showCustomModal('Peringatan Database', 'Supabase Client tidak diinisialisasi. Aplikasi akan berjalan, tetapi fitur login dan database tidak akan berfungsi.');
            }
        });
        
    </script>
</body>
</html>
